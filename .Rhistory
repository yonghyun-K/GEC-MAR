# NOTE: This code is provided solely to create example datasets used in Introduction to Regression Methods for Public Health using R
#       No warranty is provided regarding the correctness of this code or regarding any analyses carried out with the
#       datasets produced by this code.
#---
# Program Name:    NHANES 2017 2018 Process.R
# Analyst:         Ramzi W. Nahhas
# Date:            September 1, 2021
# Updated:         March 11, 2024
# Contents:        Download and process NHANES data to create example datasets
#---
# install.packages("tidyverse", "nhanesA", "Hmisc", "survey")
library(tidyverse)
library(nhanesA) # To import NHANES files
# Just to save typing
mytab  <- function(x) table(x, exclude = NULL)
myxtab <- function(x1, x2) table(x1, x2, exclude = NULL)
#---
# Load NHANES 2017-2018 data ####
#---
# Use SI units!
# Conversions from conventional to SI are not simple. https://www.ncbi.nlm.nih.gov/books/NBK33478/
# Just use variables that have SI versions.
# summary(hdl$LBDHDDSI / hdl$LBDHDD) # 0.02586 according to https://www.ncbi.nlm.nih.gov/books/NBK33478/
# summary(trigly$LBDTRSI / trigly$LBXTR) # 0.01129 according to https://www.ncbi.nlm.nih.gov/books/NBK33478/
# summary(trigly$LBDLDMSI / trigly$LBDLDLM) # 0.02586 - Same as HDL
# # The conversions different for different measures
#---
# Demographics ####
#---
# UPDATE: 3/11/2024. nhanes() now reads in the variables as factors, so the old code that converted numeric
#                    to factors results in missing values. Updated the code to remove coding as factors.
#                    cleanse_numeric=T sets missing value codes to NA.
demo    <- nhanes("DEMO_J", cleanse_numeric=T) %>% # Demographics: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DEMO_J.htm
select(SEQN, WTINT2YR, WTMEC2YR, SDMVPSU, SDMVSTRA, RIAGENDR, RIDAGEYR, RIDRETH3, DMDEDUC2, DMDHHSIZ, INDHHIN2)
# demo    <- nhanesTranslate("DEMO_J", names(demo), data = demo)
# Works but creates labels that are too long
# The NAs used to be 0 in the old version.
# Set to 0 to match the book (and the online codebook!)
summary(demo$WTMEC2YR)
demo$WTMEC2YR[is.na(demo$WTMEC2YR)] <- 0
summary(demo$WTMEC2YR)
#---
# Examination data ####
#---
bpx     <- nhanes("BPX_J", cleanse_numeric=T) %>% # Blood Pressure: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BPX_J.htm
select(SEQN, PEASCCT1, BPXPLS, BPXSY1, BPXSY2, BPXSY3, BPXDI1, BPXDI2, BPXDI3)
summary(bpx) # No missing value codes
bmx     <- nhanes("BMX_J", cleanse_numeric=T) %>% #  Body Measures: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BMX_J.htm
select(SEQN, BMXWT, BMXHT, BMXBMI, BMXARMC, BMXWAIST)
summary(bmx) # No missing value codes
dxx     <- nhanes("DXX_J", cleanse_numeric=T) %>% #  Dual-Energy X-ray Absorptiometry - Whole Body: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DXX_J.htm
select(SEQN, DXXTRFAT, DXDTRPF, DXDTOBMC, DXDTOBMD, DXDTOFAT, DXDTOPF)
summary(dxx) # No missing value codes
#---
# Laboratory data ####
#---
alb_cr <- nhanes("ALB_CR_J", cleanse_numeric=T) %>% #  Albumin & Creatinine - Urine: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/ALB_CR_J.htm
select(SEQN, URXCRS)
# No SI version for albumin
summary(alb_cr) # No missing value codes
hdl    <- nhanes("HDL_J", cleanse_numeric=T)    %>% #  Cholesterol - High - Density Lipoprotein (HDL): https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/HDL_J.htm
select(SEQN, LBDHDDSI)
summary(hdl) # No missing value codes
trigly <- nhanes("TRIGLY_J", cleanse_numeric=T) %>% #  Cholesterol - Low-Density Lipoproteins (LDL) & Triglycerides: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/TRIGLY_J.htm
select(SEQN, WTSAF2YR, LBDTRSI, LBDLDMSI)
summary(trigly) # No missing value codes
tchol  <- nhanes("TCHOL_J", cleanse_numeric=T)  %>% #  Cholesterol - Total: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/TCHOL_J.htm
select(SEQN, LBDTCSI)
summary(tchol) # No missing value codes
fertin <- nhanes("FERTIN_J", cleanse_numeric=T) %>% #  Ferritin: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/FERTIN_J.htm
select(SEQN, LBDFERSI)
summary(fertin) # No missing value codes
ghb    <- nhanes("GHB_J", cleanse_numeric=T)    %>% #  Glycohemoglobin: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/GHB_J.htm
select(SEQN, LBXGH)
summary(ghb) # No missing value codes
ins    <- nhanes("INS_J", cleanse_numeric=T)    %>% #  Insulin: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/INS_J.htm
select(SEQN, LBDINSI)
summary(ins) # No missing value codes
glu    <- nhanes("GLU_J", cleanse_numeric=T)    %>% #  Plasma Fasting Glucose: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/GLU_J.htm
select(SEQN, LBDGLUSI)
summary(glu) # No missing value codes
#---
# Questionnaire data ####
#---
alq    <- nhanes("ALQ_J", cleanse_numeric=T)    %>% #  Alcohol Use: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/ALQ_J.htm
select(SEQN, ALQ111, ALQ121, ALQ130, ALQ151)
# # Skip pattern
# table(alq$ALQ111, alq$ALQ130, exclude = NULL) # If 2, then skip
# table(alq$ALQ121, alq$ALQ130, exclude = NULL) # If 0, then skip
# table(alq$ALQ111, alq$ALQ151, exclude = NULL) # If 2, then skip
# table(alq$ALQ121, alq$ALQ151, exclude = NULL) # Not skipped
bpq    <- nhanes("BPQ_J", cleanse_numeric=T)    %>% #  Blood Pressure & Cholesterol: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BPQ_J.htm
select(SEQN, BPQ020, BPD035, BPQ080)
diq    <- nhanes("DIQ_J", cleanse_numeric=T)    %>% #  Diabetes: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DIQ_J.htm
select(SEQN, DIQ010, DID040)
dlq    <- nhanes("DLQ_J", cleanse_numeric=T)    %>% #  Disability: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DLQ_J.htm
select(SEQN, DLQ010, DLQ020)
duq    <- nhanes("DUQ_J", cleanse_numeric=T)    %>% #  Drug Use: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DUQ_J.htm
select(SEQN, DUQ200, DUQ210, DUQ213, DUQ230, DUQ240)
# # Skip pattern
# table(duq$DUQ200, duq$DUQ230, exclude = NULL) # If 2, then skip
hiq    <- nhanes("HIQ_J", cleanse_numeric=T)   %>% # Health Insurance: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/HIQ_J.htm
select(SEQN, HIQ011)
mcq    <- nhanes("MCQ_J", cleanse_numeric=T)   %>% # Medical conditions: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/MCQ_J.htm
select(SEQN, MCQ010, MCQ025,
MCQ160B, MCQ160C, MCQ160D, MCQ160E, MCQ160F,
MCD180B, MCD180C, MCD180D, MCD180E, MCD180F,
MCQ220,  MCD240A)
dpq    <- nhanes("DPQ_J", cleanse_numeric=T)   %>% # Mental Health - Depression Screener: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DPQ_J.htm
select(SEQN, DPQ010, DPQ020, DPQ030, DPQ040, DPQ050, DPQ060, DPQ070, DPQ080, DPQ090)
paq    <- nhanes("PAQ_J", cleanse_numeric=T)   %>% # Physical Activity - https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/PAQ_J.htm
select(SEQN, PAQ605, PAQ610, PAD615, PAQ635, PAQ640, PAD645, PAQ650, PAQ655, PAD660)
# # Skip pattern
# summary(paq$PAQ610[paq$PAQ605 == 2]) # Set these to 0
# summary(paq$PAD615[paq$PAQ605 == 2]) # Set these to 0
# summary(paq$PAQ640[paq$PAQ635 == 2]) # Set these to 0
# summary(paq$PAD645[paq$PAQ635 == 2]) # Set these to 0
# summary(paq$PAQ655[paq$PAQ650 == 2]) # Set these to 0
# summary(paq$PAD660[paq$PAQ650 == 2]) # Set these to 0
slq    <- nhanes("SLQ_J", cleanse_numeric=T)   %>% # Sleep Disorders: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/SLQ_J.htm
select(SEQN, SLD012, SLD013, SLQ030, SLQ040, SLQ050, SLQ120)
smq    <- nhanes("SMQ_J", cleanse_numeric=T)   %>% # Smoking - Cigarette Use - https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/SMQ_J.htm
select(SEQN, SMQ020, SMQ040)
#---
# Merge Files ####
#---
# # Count observations and variables before merging
# NOBS <- NVAR <- rep(NA, length(FILES))
# for(i in 1:length(FILES)) {
#   NOBS[i] <- nrow(get(FILES[i]))
#   NVAR[i] <- ncol(get(FILES[i]))
# }
# cbind(FILES, NOBS, NVAR)
#
# # Check for names in common before merging
# CHECK <- array(NA, dim = rep(length(FILES), 2))
# for(i in 1:dim(CHECK)[1]) {
#   for(j in 1:dim(CHECK)[2]) {
#     if (i != j) {
#       COMMON <- intersect(names(get(FILES[i])), names(get(FILES[j])))
#       if (length(COMMON) > 1) {
#         print(FILES[i])
#         print(FILES[j])
#         print(COMMON)
#       } else {
#         CHECK[i,j] <- intersect(names(get(FILES[i])), names(get(FILES[j])))
#       }
#       rm(COMMON)
#     }
#   }
# }
# # If anything printed here, then there are variables in common
# CHECK
# # Should be all SEQN except for NAs on the diagnonal
# table(CHECK, exclude = NULL)
# # Should be all SEQN, with # of NAs equal to # of datasets
# # If not, go above and remove common variables from at least one dataset
#
# # Check # of observations in commmon
# rm(CHECK)
# CHECK <- array(NA, dim = rep(length(FILES), 2))
# for(i in 1:dim(CHECK)[1]) {
#   for(j in 1:dim(CHECK)[2]) {
#     if (i != j) {
#       CHECK[i,j] <- nrow(merge(get(FILES[i]), get(FILES[j])))
#       if(CHECK[i,j] == 0) {
#         print(FILES[i])
#         print(FILES[j])
#         cat("\n\n")
#       }
#     }
#   }
# }
# CHECK
# sum(CHECK == 0, na.rm = T)
# # Even if there are some zeros you could merge
# # Some were only measured in subsamples, some of which do not overlap
# # OK to merge if you use all.x = T and merge them all with the demographics since that was on everyone.
# Merge
ls()
FILES <- c("alb_cr", "alq", "bmx", "bpq", "bpx", "demo", "diq", "dlq", "dpq", "duq", "dxx", "fertin", "ghb",
"glu", "hdl", "hiq", "ins", "mcq", "paq", "slq", "smq", "tchol", "trigly")
FILES     <- FILES[-(which(FILES == "demo"))]
nhanes0   <- merge(get("demo"), get(FILES[1]), all.x = T, by = "SEQN")
for(i in 2:length(FILES)){
nhanes0 <- merge(nhanes0,     get(FILES[i]), all.x = T, by = "SEQN")
}
dim(demo)
# 9254   10
dim(nhanes0)
# 9254  96
# How many missing values?
myfun <- function(x) sum(is.na(x))
unlist(lapply(nhanes0, myfun))
library(mice)
library(glmnet)
set.seed(123)
# Calculate missing value proportions
missing_rate <- colMeans(is.na(nhanes0))
# View variables with high missingness
missing_rate[order(-missing_rate)]
missing_rate[c("PEASCCT1", "BPXPLS", "BPXSY1", "BPXSY2", "BPXSY3", "BPXDI1", "BPXDI2", "BPXDI3")]
imputed_data <- mice(nhanes0, m = 1, method = "pmm", seed = 111, ridge = 1e-1)
# Inspect imputation summary
summary(imputed_data)
# Retrieve one of the completed datasets (e.g., first imputed dataset)
nhanes0_comp <- complete(imputed_data, 1)
save(nhanes0_comp = nhanes0_comp, nhanes0,
file = "main2_nhanes.Rdata")
getwd()
